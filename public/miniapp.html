<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{PAGE_TITLE}}</title>

    <!-- Farcaster Mini App embed metadata (injected from manifest at serve time) -->
    <meta name="fc:miniapp" content='{{FC_MINIAPP_JSON}}' />

    <!-- OpenGraph tags for embed previews -->
    <meta property="og:title" content="{{OG_TITLE}}" />
    <meta property="og:description" content="Airdrop TOWNS Members" />
    <meta property="og:image" content="{{OG_IMAGE}}" />

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(-45deg, #1a0533, #2d1b69, #4c1d95, #6d28d9);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        #loading {
            text-align: center;
            font-size: 18px;
            margin-top: 40vh;
            animation: slideIn 0.5s ease;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 44px; height: 44px;
            animation: spin 0.8s linear infinite;
            margin: 16px auto;
        }
        .spinner-sm {
            border: 3px solid rgba(255,255,255,0.2);
            border-top: 3px solid #a78bfa;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        #app {
            display: none;
            width: 100%;
            max-width: 440px;
            animation: slideIn 0.5s ease;
        }

        .card {
            background: rgba(15, 10, 30, 0.88);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 28px 22px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(139,92,246,0.25);
            border: 1px solid rgba(139,92,246,0.25);
            margin-bottom: 14px;
        }

        /* ---- Typography ---- */
        h1 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 4px;
            background: linear-gradient(135deg, #a78bfa, #c4b5fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #e0d4f5;
        }
        .subtitle {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 20px;
        }

        /* ---- Profile picture ---- */
        .pfp {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 3px solid rgba(139,92,246,0.5);
            object-fit: cover;
            margin: 0 auto 12px;
            display: block;
            background: rgba(139,92,246,0.15);
        }

        /* ---- Buttons ---- */
        button, .btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(124,58,237,0.35);
            margin: 6px 0;
            width: 100%;
            text-align: center;
            display: block;
            text-decoration: none;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124,58,237,0.5); }
        button:active { transform: translateY(0); }
        button:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }

        button.secondary {
            background: rgba(139,92,246,0.15);
            border: 1px solid rgba(139,92,246,0.35);
            box-shadow: none;
            font-size: 14px;
            padding: 12px 20px;
        }
        button.secondary:hover { background: rgba(139,92,246,0.25); box-shadow: none; }

        button.sm {
            padding: 10px 16px;
            font-size: 13px;
            width: auto;
            display: inline-block;
            margin: 4px;
        }

        button.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239,68,68,0.3);
        }

        button.joined {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 4px 15px rgba(34,197,94,0.3);
            cursor: default;
        }
        button.joined:hover { transform: none; box-shadow: 0 4px 15px rgba(34,197,94,0.3); }

        .back-btn {
            background: none;
            border: none;
            box-shadow: none;
            color: #a78bfa;
            font-size: 14px;
            font-weight: 600;
            padding: 8px 0;
            width: auto;
            text-align: left;
            margin-bottom: 8px;
            cursor: pointer;
        }
        .back-btn:hover { color: #c4b5fd; transform: none; box-shadow: none; }

        /* ---- Form elements ---- */
        input, select, textarea {
            width: 100%;
            padding: 13px 14px;
            border-radius: 12px;
            border: 1px solid rgba(139,92,246,0.3);
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { border-color: #8b5cf6; }
        select option { background: white; color: #1a0533; }
        label {
            display: block;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            opacity: 0.75;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-group { margin-bottom: 14px; }
        .hint {
            font-size: 11px;
            opacity: 0.5;
            margin-top: -6px;
            margin-bottom: 10px;
            text-align: left;
        }

        /* ---- Info rows ---- */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 11px 14px;
            background: rgba(139,92,246,0.08);
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid rgba(139,92,246,0.15);
        }
        .info-label { font-size: 12px; opacity: 0.65; }
        .info-value { font-size: 14px; font-weight: 600; color: #c4b5fd; }

        /* ---- Status badges ---- */
        .status-badge {
            display: inline-block;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-pending { background: rgba(234,179,8,0.15); color: #fbbf24; border: 1px solid rgba(234,179,8,0.25); }
        .status-funded { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.25); }
        .status-distributing { background: rgba(139,92,246,0.15); color: #a78bfa; border: 1px solid rgba(139,92,246,0.25); animation: pulse 1.5s infinite; }
        .status-completed { background: rgba(34,197,94,0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.25); }
        .status-cancelled { background: rgba(239,68,68,0.15); color: #f87171; border: 1px solid rgba(239,68,68,0.25); }

        /* ---- Airdrop card (for lists) ---- */
        .airdrop-card {
            background: rgba(139,92,246,0.06);
            border: 1px solid rgba(139,92,246,0.2);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 10px;
            text-align: left;
            animation: fadeIn 0.3s ease;
        }
        .airdrop-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .airdrop-card-title {
            font-weight: 700;
            font-size: 15px;
            color: #e0d4f5;
        }
        .airdrop-card-detail {
            font-size: 12px;
            opacity: 0.6;
            margin-bottom: 4px;
        }
        .airdrop-card-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        /* ---- Participants list ---- */
        .participants-list {
            max-height: 180px;
            overflow-y: auto;
            text-align: left;
            margin-top: 10px;
        }
        .participant {
            font-family: monospace;
            font-size: 11px;
            padding: 5px 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            margin-bottom: 3px;
            word-break: break-all;
        }

        /* ---- Alerts ---- */
        .error {
            background: rgba(239,68,68,0.15);
            padding: 11px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid rgba(239,68,68,0.3);
            font-size: 13px;
            color: #fca5a5;
        }
        .success {
            background: rgba(34,197,94,0.15);
            padding: 11px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid rgba(34,197,94,0.3);
            font-size: 13px;
            color: #86efac;
        }
        .info-box {
            background: rgba(59,130,246,0.1);
            padding: 11px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid rgba(59,130,246,0.25);
            font-size: 13px;
            color: #93c5fd;
        }

        .hidden { display: none !important; }

        .mono {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            word-break: break-all;
            opacity: 0.55;
            background: rgba(0,0,0,0.2);
            padding: 6px 8px;
            border-radius: 6px;
            margin-top: 6px;
        }

        a { color: #a78bfa; text-decoration: none; }
        a:hover { text-decoration: underline; }

        .divider {
            height: 1px;
            background: rgba(139,92,246,0.15);
            margin: 16px 0;
        }

        .empty-state {
            text-align: center;
            padding: 30px 16px;
            opacity: 0.5;
            font-size: 14px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            border-bottom: 1px solid rgba(139,92,246,0.1);
        }
        .summary-row:last-child { border-bottom: none; }
        .summary-label { opacity: 0.65; }
        .summary-value { font-weight: 600; color: #c4b5fd; }

        .poll-status {
            font-size: 11px;
            opacity: 0.4;
            margin-top: 8px;
            text-align: center;
        }

        /* ---- Leaderboard ---- */
        .leaderboard-section { margin-bottom: 20px; }
        .leaderboard-section h3 {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.6;
            margin-bottom: 8px;
        }
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(139,92,246,0.06);
            border: 1px solid rgba(139,92,246,0.15);
            border-radius: 10px;
            margin-bottom: 6px;
            font-size: 13px;
        }
        .leaderboard-rank {
            font-weight: 800;
            font-size: 16px;
            color: #a78bfa;
            min-width: 24px;
            text-align: center;
        }
        .leaderboard-rank.gold { color: #fbbf24; }
        .leaderboard-rank.silver { color: #94a3b8; }
        .leaderboard-rank.bronze { color: #d97706; }
        .leaderboard-name {
            flex: 1;
            font-weight: 600;
            color: #e0d4f5;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .leaderboard-stat {
            font-size: 12px;
            color: #a78bfa;
            font-weight: 600;
            white-space: nowrap;
        }

        /* ---- Link preview ---- */
        .link-preview {
            background: rgba(59,130,246,0.08);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 8px;
            padding: 10px 12px;
            margin-top: 6px;
            font-size: 12px;
            word-break: break-all;
        }
        .link-preview a {
            color: #93c5fd;
            text-decoration: none;
        }
        .link-preview a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loading">
        <div class="spinner"></div>
        <div>Loading Airdrop App...</div>
    </div>

    <!-- Main app container -->
    <div id="app">

        <!-- ===================== HOME SCREEN ===================== -->
        <div id="homeScreen" class="card">
            <img class="pfp" src="/icon.png" alt="App Icon" />
            <h1 style="text-align:center;">Welcome</h1>
            <div id="homeUsername" style="text-align:center; font-size:16px; font-weight:600; color:#c4b5fd; margin-bottom:20px;"></div>

            <button id="btnCreateAirdrop">Create an Airdrop</button>
            <button id="btnJoinPublic" class="secondary" style="margin-top:8px;">Join a Public Airdrop</button>
            <button id="btnHistory" class="secondary" style="margin-top:8px;">Airdrop History</button>
            <button id="btnLeaderboard" class="secondary" style="margin-top:8px;">Leaderboard</button>

            <div id="adminHomeSection" class="hidden" style="margin-top:24px;">
                <div class="divider"></div>
                <button id="btnRecoverFunds" class="danger" style="margin-top:8px;">Recover Treasury Funds</button>
            </div>
        </div>

        <!-- ===================== CREATE AIRDROP SCREEN ===================== -->
        <div id="createScreen" class="hidden">
            <div class="card">
                <button class="back-btn" id="createBackBtn">&larr; Back</button>
                <h2>Create an Airdrop</h2>

                <div class="form-group">
                    <label>Airdrop Type</label>
                    <select id="airdropTypeSelect">
                        <option value="space">Airdrop Space Members</option>
                        <option value="public">Public Airdrop</option>
                    </select>
                </div>

                <!-- Public airdrop: Title, Description, Max Participants -->
                <div id="publicTitleGroup" class="hidden">
                    <div class="form-group">
                        <label>Title (optional)</label>
                        <input type="text" id="airdropTitleInput" placeholder="e.g. Community Reward" maxlength="100" />
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <textarea id="airdropDescInput" placeholder="Describe your airdrop..." rows="2" maxlength="500" style="resize:vertical;"></textarea>
                        <div class="hint"></div>
                    </div>
                    <div class="form-group">
                        <label>Max Participants (optional)</label>
                        <input type="number" id="maxParticipantsInput" placeholder="Leave empty for unlimited" min="1" />
                        <div class="hint">Distribution starts automatically when max is reached</div>
                    </div>
                </div>

                <!-- Space members: holder info -->
                <div id="holderSection">
                    <div id="holderLoading" class="info-box">
                        <span class="spinner-sm"></span> Fetching NFT Holders...
                    </div>
                    <div id="holderResult" class="hidden">
                        <div class="info-row hidden" id="holderNameRow">
                            <span class="info-label">Space</span>
                            <span class="info-value" id="holderSpaceName" style="font-weight:700; color:#e0d4f5;">-</span>
                        </div>
                        <div class="info-row" id="holderNftRow">
                            <span class="info-label">Space Contract</span>
                            <span class="info-value" id="holderNftAddress" style="font-size:11px; font-family:'Monaco','Courier New',monospace; word-break:break-all;">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Participants Found</span>
                            <span class="info-value" id="holderCount">0</span>
                        </div>
                    </div>
                    <!-- Role filter (space only) -->
                    <div id="roleFilterSection" class="hidden" style="margin-top:8px;">
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Filter by Role (optional)</label>
                            <select id="roleSelect" style="font-size:13px;">
                                <option value="">All Members</option>
                            </select>
                            <div class="hint">Only airdrop to members with this role</div>
                        </div>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label>Currency</label>
                    <select id="currencySelect">
                        <option value="towns">$TOWNS (default)</option>
                        <option value="usdc">$USDC</option>
                        <option value="weth">$WETH</option>
                        <option value="cbbtc">$cbBTC</option>
                        <option value="custom">Custom Token</option>
                    </select>
                </div>
                <div id="customCurrencyGroup" class="form-group hidden">
                    <label>Token Contract Address (Base)</label>
                    <input type="text" id="customCurrencyInput" placeholder="0x... (ERC20 on Base)" />
                    <div class="hint">Paste the ERC20 token contract address on Base chain</div>
                    <div id="tokenInfoLoading" class="hidden" style="margin-top:6px; font-size:12px; opacity:0.6;">
                        <span class="spinner-sm" style="width:12px; height:12px; border-width:2px;"></span> Looking up token...
                    </div>
                    <div id="tokenInfoDisplay" class="hidden" style="
                        margin-top:6px;
                        padding:8px 12px;
                        background:rgba(139,92,246,0.1);
                        border:1px solid rgba(139,92,246,0.25);
                        border-radius:8px;
                        font-size:13px;
                        display:flex;
                        align-items:center;
                        gap:8px;
                    ">
                        <span id="tokenInfoName" style="font-weight:600; color:#c4b5fd;"></span>
                        <span id="tokenInfoSymbol" style="color:#a78bfa;"></span>
                        <span id="tokenInfoAddr" style="font-family:'Monaco','Courier New',monospace; font-size:11px; opacity:0.5;"></span>
                    </div>
                    <div id="tokenInfoError" class="hidden" style="margin-top:6px; font-size:12px; color:#fca5a5;"></div>
                </div>

                <div class="form-group">
                    <label>Total Amount (tokens)</label>
                    <input type="text" id="amountInput" placeholder="e.g. 100" inputmode="decimal" />
                    <div class="hint">Enter the total number of tokens to airdrop</div>
                </div>

                <!-- Tax & per-person summary -->
                <div id="taxSummary" class="hidden" style="margin-top:8px;">
                    <div id="holderTaxRow" style="border:1px solid rgba(234,179,8,0.2); background:rgba(234,179,8,0.06); border-radius:10px; margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:11px 14px;">
                            <span class="info-label">Holders Tax (<span id="taxPercentLabel">2</span>%)</span>
                            <span class="info-value" style="color:#fbbf24;" id="taxAmountLabel">-</span>
                        </div>
                        <div id="taxNote" class="hidden" style="padding:0 14px 8px; text-align:center;">
                            <span style="font-size:11px; font-style:italic; opacity:0.55;">Distributed to <span id="taxMemberCount">0</span> Crypto Lab's town members</span>
                        </div>
                    </div>
                    <div class="info-row hidden" id="adminTaxRow" style="border-color:rgba(234,179,8,0.2); background:rgba(234,179,8,0.06);">
                        <span class="info-label">Admin Tax (<span id="adminTaxPercentLabel">1</span>%)</span>
                        <span class="info-value" style="color:#fbbf24;" id="adminTaxAmountLabel">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Net to Recipients</span>
                        <span class="info-value" id="netAmountLabel">-</span>
                    </div>
                </div>
                <div id="perPersonSummary" class="hidden">
                    <div class="info-row">
                        <span class="info-label">Per Recipient</span>
                        <span class="info-value" id="perPersonAmount">-</span>
                    </div>
                </div>

                <div style="margin-top:16px;">
                    <button id="launchAirdropBtn" disabled>Launch Airdrop</button>
                </div>

                <div id="createError" class="error hidden"></div>
            </div>
        </div>

        <!-- ===================== DEPOSIT SCREEN ===================== -->
        <div id="depositScreen" class="hidden">
            <div class="card">
                <button class="back-btn" id="depositBackBtn">&larr; Back</button>
                <h2>Deposit Tokens</h2>

                <!-- Summary -->
                <div id="depositSummary">
                    <div class="summary-row">
                        <span class="summary-label">Total Deposit</span>
                        <span class="summary-value" id="depositTotal">-</span>
                    </div>
                    <div class="summary-row" id="depositTaxRow">
                        <span class="summary-label">Holders Tax (<span id="depositTaxPercent">2</span>%)</span>
                        <span class="summary-value" id="depositTaxAmount" style="color:#fbbf24;">-</span>
                    </div>
                    <div class="summary-row hidden" id="depositAdminTaxRow">
                        <span class="summary-label">Admin Tax (<span id="depositAdminTaxPercent">1</span>%)</span>
                        <span class="summary-value" id="depositAdminTaxAmount" style="color:#fbbf24;">-</span>
                    </div>
                    <div class="summary-row" id="depositNetRow">
                        <span class="summary-label">Net to Recipients</span>
                        <span class="summary-value" id="depositNetAmount">-</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Token</span>
                        <span class="summary-value" id="depositToken">$TOWNS</span>
                    </div>
                </div>

                <div class="divider"></div>

                <!-- Primary: Towns interaction request (sent to chat) -->
                <div id="depositInteractionSection">
                    <div style="text-align:center; padding:12px 0;">
                        <div class="spinner-sm" id="depositInteractionSpinner"></div>
                        <div id="depositInteractionMsg" style="margin-top:10px; font-size:14px; line-height:1.6;">
                            Sending transaction request to your Towns chat...
                        </div>
                    </div>
                    <div id="depositWaitingSection" class="hidden" style="text-align:center; padding:8px 0;">
                        <div class="info-box" style="margin-bottom:14px;">
                            <strong>A transaction request has been sent!</strong><br/>
                            Check your Towns chat and approve the deposit transaction.<br/>
                            This page will update automatically once confirmed.
                        </div>
                        <div class="spinner-sm" style="margin:0 auto;"></div>
                        <div style="font-size:12px; opacity:0.6; margin-top:8px;" id="depositPollStatus">Waiting for confirmation...</div>
                    </div>
                    <button class="secondary" id="showManualDepositBtn" style="margin-top:12px; font-size:12px;">
                        Deposit manually instead
                    </button>
                </div>

                <!-- Fallback: Manual deposit -->
                <div id="depositSendSection" class="hidden">
                    <div style="text-align:center; margin-bottom:12px;">
                        <div style="font-size:13px; opacity:0.7; margin-bottom:8px;">Send to Bot Treasury</div>
                        <div id="depositTreasuryFull" style="
                            font-family: 'Monaco','Courier New',monospace;
                            font-size: 12px;
                            word-break: break-all;
                            background: rgba(0,0,0,0.3);
                            padding: 12px;
                            border-radius: 10px;
                            border: 1px solid rgba(139,92,246,0.25);
                            user-select: all;
                            cursor: pointer;
                            color: #c4b5fd;
                        ">-</div>
                        <button class="secondary" id="copyAddressBtn" style="margin-top:8px; font-size:12px; padding:8px 16px; width:auto; display:inline-block;">
                            Copy Address
                        </button>
                        <div id="copiedMsg" style="font-size:11px; color:#4ade80; margin-top:4px; opacity:0;" aria-live="polite">Copied!</div>
                    </div>

                    <div class="info-box" style="margin-bottom:14px;">
                        <strong>How to deposit:</strong><br/>
                        1. Copy the treasury address above<br/>
                        2. Send <strong id="depositAmountInstructions">-</strong> from your wallet to that address on <strong>Base</strong><br/>
                        3. Paste the transaction hash below to confirm
                    </div>

                    <div class="form-group">
                        <label>Transaction Hash</label>
                        <input type="text" id="manualTxHashInput" placeholder="0x..." />
                    </div>
                    <button id="confirmManualDepositBtn">Confirm Deposit</button>
                </div>

                <div id="depositProcessing" class="hidden" style="text-align:center; padding:16px 0;">
                    <div class="spinner-sm"></div> Verifying deposit on-chain...
                </div>

                <div id="depositError" class="error hidden"></div>
                <div id="depositSuccess" class="success hidden"></div>
            </div>
        </div>

        <!-- ===================== PUBLIC AIRDROPS SCREEN ===================== -->
        <div id="publicScreen" class="hidden">
            <div class="card">
                <button class="back-btn" id="publicBackBtn">&larr; Back</button>
                <h2>Public Airdrops</h2>
                <div class="subtitle">Browse and join available airdrops</div>

                <div id="publicLoading" style="text-align:center; padding:20px 0;">
                    <div class="spinner-sm"></div> Loading airdrops...
                </div>

                <div id="publicList"></div>
                <div id="publicEmpty" class="empty-state hidden">No public airdrops available right now.</div>

                <div id="publicError" class="error hidden"></div>
            </div>
        </div>

        <!-- ===================== STATUS / MANAGE SCREEN ===================== -->
        <div id="statusScreen" class="hidden">
            <div class="card">
                <button class="back-btn" id="statusBackBtn">&larr; Back</button>
                <h2>Airdrop Status</h2>

                <div id="statusTitle" class="hidden" style="font-weight:700; font-size:16px; color:#e0d4f5; text-align:center; margin-bottom:4px;"></div>
                <div id="statusDesc" class="hidden" style="font-size:13px; opacity:0.7; text-align:center; margin-bottom:10px;"></div>

                <div style="text-align:center; margin:12px 0;">
                    <span class="status-badge" id="statusBadge">PENDING</span>
                </div>

                <div class="info-row">
                    <span class="info-label">Type</span>
                    <span class="info-value" id="statusType">-</span>
                </div>
                <div class="info-row hidden" id="statusRoleRow">
                    <span class="info-label">Role Filter</span>
                    <span class="info-value" id="statusRoleName" style="color:#a78bfa;">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Total Amount</span>
                    <span class="info-value" id="statusTotal">-</span>
                </div>
                <div id="statusTaxRow" class="hidden" style="border:1px solid rgba(234,179,8,0.2); background:rgba(234,179,8,0.06); border-radius:10px; margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:11px 14px;">
                        <span class="info-label">Holders Tax (<span id="statusTaxPercent">2</span>%)</span>
                        <span class="info-value" style="color:#fbbf24;" id="statusTaxAmount">-</span>
                    </div>
                    <div id="statusTaxNote" class="hidden" style="padding:0 14px 8px; text-align:center;">
                        <span style="font-size:11px; font-style:italic; opacity:0.55;">Distributed to <span id="statusTaxMemberCount">0</span> Crypto Lab's town members</span>
                    </div>
                </div>
                <div class="info-row hidden" id="statusAdminTaxRow" style="border-color:rgba(234,179,8,0.2); background:rgba(234,179,8,0.06);">
                    <span class="info-label">Admin Tax (<span id="statusAdminTaxPercent">1</span>%)</span>
                    <span class="info-value" style="color:#fbbf24;" id="statusAdminTaxAmount">-</span>
                </div>
                <div class="info-row hidden" id="statusNetRow">
                    <span class="info-label">Net to Recipients</span>
                    <span class="info-value" id="statusNetAmount">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Per Recipient</span>
                    <span class="info-value" id="statusPerRecipient">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Participants</span>
                    <span class="info-value" id="statusRecipientCount">0</span>
                </div>

                <!-- Max participants info -->
                <div class="info-row hidden" id="statusMaxParticipantsRow">
                    <span class="info-label">Max Participants</span>
                    <span class="info-value" id="statusMaxParticipants">-</span>
                </div>

                <!-- Pending actions (creator can fund or cancel) -->
                <div id="statusPendingSection" class="hidden" style="margin-top:16px;">
                    <button id="statusFundBtn">Fund This Airdrop</button>
                    <button id="statusCancelBtn" class="danger" style="margin-top:8px;">Cancel Airdrop</button>
                </div>

                <!-- Join section (public, funded) -->
                <div id="statusJoinSection" class="hidden" style="margin-top:16px;">
                    <button id="statusJoinBtn">Join This Airdrop</button>
                </div>

                <!-- Participants list (public, funded) -->
                <div id="statusParticipantsSection" class="hidden" style="margin-top:12px;">
                    <label>Participants</label>
                    <div class="participants-list" id="statusParticipantsList"></div>
                </div>

                <!-- Manage / Distribute (creator of public, funded) -->
                <div id="statusManageSection" class="hidden" style="margin-top:16px;">
                    <button id="statusDistributeBtn">Distribute Now</button>
                    <div class="hint" style="text-align:center;">Launch the distribution to all joined participants</div>
                </div>

                <!-- Admin cancel (visible to admin only) -->
                <div id="statusAdminSection" class="hidden" style="margin-top:16px;">
                    <button class="danger" id="statusAdminCancelBtn">Admin: Cancel &amp; Refund</button>
                </div>

                <!-- Result -->
                <div id="statusResultSection" class="hidden" style="margin-top:16px;">
                    <div id="statusResultMessage"></div>
                </div>

                <div id="statusError" class="error hidden"></div>
                <div class="poll-status" id="pollStatus"></div>

                <div class="divider"></div>
                <button class="secondary" id="statusHomeBtn">Back to Home</button>
            </div>
        </div>

        <!-- ===================== LEADERBOARD SCREEN ===================== -->
        <div id="leaderboardScreen" class="hidden">
            <div class="card">
                <button class="back-btn" id="leaderboardBackBtn">&larr; Back</button>
                <h2>Leaderboard</h2>

                <div id="leaderboardLoading" style="text-align:center; padding:20px 0;">
                    <div class="spinner-sm"></div> Loading leaderboard...
                </div>

                <div id="leaderboardContent" class="hidden">
                    <div class="leaderboard-section">
                        <h3>Top Airdrop Recipients</h3>
                        <div id="lbRecipients"></div>
                        <div id="lbRecipientsEmpty" class="empty-state hidden" style="padding:12px;">No data yet</div>
                    </div>
                    <div class="leaderboard-section">
                        <h3>Top Airdrop Creators</h3>
                        <div id="lbCreators"></div>
                        <div id="lbCreatorsEmpty" class="empty-state hidden" style="padding:12px;">No data yet</div>
                    </div>
                    <div class="leaderboard-section">
                        <h3>Top Airdropped Towns</h3>
                        <div id="lbSpaces"></div>
                        <div id="lbSpacesEmpty" class="empty-state hidden" style="padding:12px;">No data yet</div>
                    </div>
                </div>

                <div id="leaderboardError" class="error hidden"></div>

                <div id="leaderboardAdminSection" class="hidden" style="margin-top:16px;">
                    <div class="divider"></div>
                    <button class="danger sm" id="resetLeaderboardBtn">Reset Leaderboard</button>
                </div>
            </div>
        </div>

        <!-- ===================== HISTORY SCREEN ===================== -->
        <div id="historyScreen" class="hidden">
            <div class="card">
                <button class="back-btn" id="historyBackBtn">&larr; Back</button>
                <h2>Airdrop History</h2>
                <div class="subtitle">All completed and past airdrops</div>

                <div id="historyLoading" style="text-align:center; padding:20px 0;">
                    <div class="spinner-sm"></div> Loading history...
                </div>

                <div id="historyList"></div>
                <div id="historyEmpty" class="empty-state hidden">No airdrop history yet.</div>

                <div id="historyError" class="error hidden"></div>

                <div id="historyAdminSection" class="hidden" style="margin-top:16px;">
                    <div class="divider"></div>
                    <button class="danger sm" id="resetHistoryBtn">Reset History</button>
                </div>
            </div>
        </div>

        <!-- ===================== RECOVER FUNDS SCREEN ===================== -->
        <div id="recoverScreen" class="hidden">
            <div class="card">
                <button class="back-btn" id="recoverBackBtn">&larr; Back</button>
                <h2>Recover Treasury Funds</h2>
                <div class="subtitle">Transfer tokens from the bot treasury to your wallet</div>

                <div class="form-group" style="margin-top:16px;">
                    <label>Select Token</label>
                    <select id="recoverTokenSelect">
                        <option value="towns">$TOWNS</option>
                        <option value="usdc">$USDC</option>
                        <option value="weth">$WETH</option>
                        <option value="cbbtc">$cbBTC</option>
                        <option value="custom">Custom Token</option>
                    </select>
                </div>

                <div id="recoverCustomGroup" class="hidden">
                    <div class="form-group">
                        <label>Token Contract Address</label>
                        <input type="text" id="recoverCustomInput" placeholder="0x..." />
                    </div>
                </div>

                <div id="recoverBalanceSection" class="hidden" style="margin-top:12px;">
                    <div class="info-row">
                        <span class="info-label">Treasury Balance</span>
                        <span class="info-value" id="recoverBalance">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Treasury Address</span>
                        <span class="info-value" id="recoverTreasury" style="font-size:11px; font-family:monospace;">-</span>
                    </div>
                </div>

                <div id="recoverBalanceLoading" class="hidden" style="text-align:center; padding:12px;">
                    <span class="spinner-sm"></span> Checking balance...
                </div>

                <div class="form-group" style="margin-top:12px;">
                    <label>Amount to Recover</label>
                    <input type="text" id="recoverAmountInput" placeholder="Amount in tokens (or 'max')" />
                    <div class="hint">Type "max" to recover the full balance</div>
                </div>

                <button id="recoverBtn" disabled style="margin-top:16px;">Recover Funds</button>

                <div id="recoverSuccess" class="success hidden" style="margin-top:12px;"></div>
                <div id="recoverError" class="error hidden" style="margin-top:8px;"></div>
            </div>
        </div>

    </div>

    <script type="module">
        import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk@0.2.1'

        // Dismiss splash screen immediately
        sdk.actions.ready().catch(() => {})

        // ==================================================================
        // State
        // ==================================================================
        let context = null
        let currentAirdrop = null
        let holderCount = 0
        let taxHolderCount = 0
        let botTreasuryAddress = ''
        let pollInterval = null
        let spaceRoles = [] // cached roles for the space
        let selectedRoleId = null
        let selectedRoleName = ''
        let taxPercent = 2 // default, updated from /api/config
        let adminTaxPercent = 1
        let totalTaxPercent = 3
        let taxEnabled = false
        let adminTaxEnabled = false
        let resolvedUserWallet = '' // smart wallet resolved from userId
        let isAdmin = false // whether current user is the bot admin
        let adminAddress = '' // bot admin address

        // Towns token default address
        const TOWNS_ADDRESS = '0x00000000A22C618fd6b4D7E9A335C4B96B189a38'

        // Predefined token registry: { selectValue: { address, symbol, decimals } }
        const KNOWN_TOKENS = {
            towns: { address: TOWNS_ADDRESS, symbol: 'TOWNS', decimals: 18 },
            usdc:  { address: '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913', symbol: 'USDC', decimals: 6 },
            weth:  { address: '0x4200000000000000000000000000000000000006', symbol: 'WETH', decimals: 18 },
            cbbtc: { address: '0xcbB7C0000aB88B473b1f5aFd9ef808440eed33Bf', symbol: 'cbBTC', decimals: 8 },
        }

        // ==================================================================
        // SDK Init
        // ==================================================================
        async function initSDK() {
            try {
                context = await Promise.race([
                    sdk.context,
                    new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 10000))
                ])
                if (!context?.towns?.user?.userId) throw new Error('Missing Towns user data')
                return context
            } catch (err) {
                console.error('SDK init failed:', err)
                throw err
            }
        }

        // ==================================================================
        // Screen navigation
        // ==================================================================
        const screens = ['homeScreen', 'createScreen', 'depositScreen', 'publicScreen', 'statusScreen', 'leaderboardScreen', 'historyScreen', 'recoverScreen']
        const screenHistory = ['homeScreen']

        function showScreen(name, skipHistory) {
            // Track navigation history
            if (!skipHistory) {
                const currentScreen = screens.find(id => !document.getElementById(id).classList.contains('hidden'))
                if (currentScreen && currentScreen !== name) {
                    screenHistory.push(currentScreen)
                }
            }
            screens.forEach(id => {
                const el = document.getElementById(id)
                if (id === name) el.classList.remove('hidden')
                else el.classList.add('hidden')
            })
            // Stop polling when leaving status screen
            if (name !== 'statusScreen' && pollInterval) {
                clearInterval(pollInterval)
                pollInterval = null
            }
        }

        function goBack() {
            if (screenHistory.length > 0) {
                const prev = screenHistory.pop()
                showScreen(prev, true)
                // Refresh data when returning to list screens
                if (prev === 'publicScreen') loadPublicAirdrops()
                if (prev === 'historyScreen') loadHistory()
            } else {
                showScreen('homeScreen', true)
            }
        }

        /** Check if current user is in a participants list */
        function isUserInParticipants(participants) {
            if (!participants || participants.length === 0) return false
            const uid = (context?.towns?.user?.userId || '').toLowerCase()
            const uaddr = (context?.towns?.user?.address || '').toLowerCase()
            return participants.some(p => {
                const lower = p.toLowerCase()
                return lower === uid
                    || (uaddr && lower === uaddr)
                    || (resolvedUserWallet && lower === resolvedUserWallet)
            })
        }

        // ==================================================================
        // Helpers
        // ==================================================================
        function showError(elId, msg) {
            const el = document.getElementById(elId)
            el.textContent = msg
            el.classList.remove('hidden')
        }
        function hideError(elId) {
            document.getElementById(elId).classList.add('hidden')
        }

        /**
         * Get the space contract address from:
         * 1. URL query param (passed by /drop command)
         * 2. context.towns.spaceId (may be encoded stream ID)
         * Towns encodes spaceId as: type-prefix(2 hex chars) + address(40 hex chars) + padding
         */
        function getSpaceAddress() {
            // 1. From URL query param (already extracted by bot)
            const urlParams = new URLSearchParams(window.location.search)
            const fromUrl = urlParams.get('spaceId')
            if (fromUrl && /^0x[a-fA-F0-9]{40}$/.test(fromUrl)) return fromUrl

            // 2. From context.towns.spaceId
            const raw = context?.towns?.spaceId || ''
            if (!raw) return ''
            // Already a valid address
            if (/^0x[a-fA-F0-9]{40}$/.test(raw)) return raw
            // Encoded stream ID: strip 0x, skip 2-char type prefix, take 40-char address
            const hex = raw.startsWith('0x') ? raw.slice(2) : raw
            if (hex.length >= 42) {
                const candidate = '0x' + hex.slice(2, 42)
                if (/^0x[a-fA-F0-9]{40}$/.test(candidate)) return candidate
            }
            return raw // return raw as fallback
        }

        function getActiveDecimals() {
            const sel = document.getElementById('currencySelect').value
            if (KNOWN_TOKENS[sel]) return KNOWN_TOKENS[sel].decimals
            return resolvedTokenDecimals
        }

        function tokensToWei(tokens, decimals) {
            const d = decimals ?? getActiveDecimals()
            const s = tokens.trim()
            if (!s || isNaN(Number(s))) return null
            try {
                const parts = s.split('.')
                const whole = parts[0] || '0'
                const frac = (parts[1] || '').padEnd(d, '0').slice(0, d)
                return (BigInt(whole) * 10n ** BigInt(d) + BigInt(frac)).toString()
            } catch { return null }
        }

        function weiToTokens(wei, decimals) {
            const d = decimals ?? getActiveDecimals()
            try {
                const n = BigInt(wei)
                const whole = n / 10n ** BigInt(d)
                const frac = n % 10n ** BigInt(d)
                const fracStr = frac.toString().padStart(d, '0').replace(/0+$/, '')
                if (fracStr) return `${whole}.${fracStr}`
                return `${whole}`
            } catch { return wei }
        }

        function formatTokens(wei, decimals) {
            const t = weiToTokens(wei, decimals)
            const num = Number(t)
            if (num >= 0.01) return num.toFixed(4).replace(/\.?0+$/, '')
            if (num > 0) return num.toFixed(8).replace(/\.?0+$/, '')
            return t
        }

        function shortAddr(a) {
            if (!a || a.length < 12) return a || ''
            return a.slice(0, 6) + '...' + a.slice(-4)
        }

        function getTokenSymbol() {
            const sel = document.getElementById('currencySelect').value
            if (KNOWN_TOKENS[sel]) return KNOWN_TOKENS[sel].symbol
            if (resolvedTokenSymbol) return resolvedTokenSymbol
            return ''
        }

        function getTokenLabel() {
            const sym = getTokenSymbol()
            if (sym) return '$' + sym
            if (resolvedTokenName) return resolvedTokenName
            const custom = document.getElementById('customCurrencyInput').value.trim()
            return custom ? shortAddr(custom) : 'Token'
        }

        function getTokenAddress() {
            const sel = document.getElementById('currencySelect').value
            if (KNOWN_TOKENS[sel]) return KNOWN_TOKENS[sel].address
            return document.getElementById('customCurrencyInput').value.trim() || TOWNS_ADDRESS
        }

        // Encode ERC20 transfer(address,uint256) calldata
        function encodeErc20Transfer(to, amountWei) {
            const sel = 'a9059cbb'
            const addr = to.replace('0x', '').toLowerCase().padStart(64, '0')
            const amt = BigInt(amountWei).toString(16).padStart(64, '0')
            return '0x' + sel + addr + amt
        }

        // Compute tax/net on the client (mirrors server logic)
        function computeTaxClient(totalWei) {
            const holderBps = BigInt(Math.round(taxPercent * 100))
            const adminBps = BigInt(Math.round(adminTaxPercent * 100))
            const total = BigInt(totalWei)
            const holderTax = (total * holderBps) / 10000n
            const adminTax = adminTaxEnabled ? (total * adminBps) / 10000n : 0n
            const net = total - holderTax - adminTax
            return { holderTax, adminTax, net }
        }

        // ==================================================================
        // API calls
        // ==================================================================
        async function apiFetchConfig() {
            try {
                const res = await fetch('/api/config')
                if (!res.ok) return
                const data = await res.json()
                taxPercent = data.taxPercent ?? 2
                adminTaxPercent = data.adminTaxPercent ?? 1
                totalTaxPercent = data.totalTaxPercent ?? (taxPercent + adminTaxPercent)
                taxEnabled = data.taxEnabled ?? false
                adminTaxEnabled = data.adminTaxEnabled ?? false
                botTreasuryAddress = data.botAddress || botTreasuryAddress
                if (data.taxHolderCount > 0) {
                    taxHolderCount = data.taxHolderCount
                    document.getElementById('taxMemberCount').textContent = taxHolderCount
                }
                if (data.adminAddress) {
                    adminAddress = data.adminAddress.toLowerCase()
                }
            } catch { /* use defaults */ }
        }

        async function apiFetchHolders() {
            const spaceAddr = getSpaceAddress()
            const url = spaceAddr ? `/api/holders?spaceId=${encodeURIComponent(spaceAddr)}` : '/api/holders'
            console.log('[Holders] Fetching with spaceAddress:', spaceAddr)
            const res = await fetch(url)
            if (!res.ok) throw new Error('Failed to fetch holders')
            return await res.json()
        }

        async function apiFetchRoles() {
            const spaceAddr = getSpaceAddress()
            if (!spaceAddr) return []
            try {
                const res = await fetch(`/api/roles?spaceId=${encodeURIComponent(spaceAddr)}`)
                if (!res.ok) return []
                return await res.json()
            } catch (err) {
                console.error('[Roles] Failed to fetch roles:', err)
                return []
            }
        }

        function populateRoleDropdown(roles) {
            const sel = document.getElementById('roleSelect')
            // Keep the "All Members" default option
            sel.innerHTML = '<option value="">All Members</option>'
            for (const role of roles) {
                const opt = document.createElement('option')
                opt.value = role.id
                opt.textContent = role.name
                sel.appendChild(opt)
            }
            if (roles.length > 0) {
                document.getElementById('roleFilterSection').classList.remove('hidden')
            } else {
                document.getElementById('roleFilterSection').classList.add('hidden')
            }
        }

        async function apiCreateAirdrop(airdropType, totalAmountWei, creatorAddress, currency, decimals, displayName, symbol, title, description, maxParticipants) {
            const spaceAddr = getSpaceAddress()
            const body = {
                airdropType, totalAmount: totalAmountWei, creatorAddress,
                currency, currencySymbol: symbol, spaceId: spaceAddr,
                currencyDecimals: decimals, creatorDisplayName: displayName,
            }
            if (title) body.title = title
            if (description) body.description = description
            if (maxParticipants && maxParticipants > 0) body.maxParticipants = maxParticipants
            if (airdropType === 'space' && selectedRoleId) {
                body.roleId = selectedRoleId
                body.roleName = selectedRoleName
            }
            const res = await fetch('/api/airdrop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            if (!res.ok) {
                const err = await res.json().catch(() => ({}))
                throw new Error(err.error || 'Failed to create airdrop')
            }
            return await res.json()
        }

        async function apiConfirmDeposit(airdropId, txHash) {
            const res = await fetch(`/api/airdrop/${airdropId}/confirm-deposit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ txHash })
            })
            if (!res.ok) {
                const err = await res.json().catch(() => ({}))
                throw new Error(err.error || 'Failed to confirm deposit')
            }
            return await res.json()
        }

        async function apiJoinAirdrop(airdropId) {
            const userAddress = context?.towns?.user?.address || ''
            const userId = context?.towns?.user?.userId || ''
            const displayName = context?.user?.displayName || ''
            if (!userAddress && !userId) throw new Error('No wallet or user ID available')
            const res = await fetch(`/api/airdrop/${airdropId}/join`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userAddress, userId, displayName })
            })
            if (!res.ok) {
                const err = await res.json().catch(() => ({}))
                throw new Error(err.error || 'Failed to join')
            }
            const data = await res.json()
            // After joining, update resolvedUserWallet so alreadyJoined checks work
            if (data.participants && !resolvedUserWallet) {
                const uid = userId.toLowerCase()
                const uaddr = userAddress.toLowerCase()
                // The last added participant is likely ours
                const last = data.participants[data.participants.length - 1]
                if (last) resolvedUserWallet = last.toLowerCase()
            }
            return data
        }

        async function apiLaunchAirdrop(airdropId) {
            const res = await fetch(`/api/airdrop/${airdropId}/launch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            if (!res.ok) {
                const err = await res.json().catch(() => ({}))
                throw new Error(err.error || 'Failed to launch')
            }
            return await res.json()
        }

        async function apiGetAirdrop(airdropId) {
            const res = await fetch(`/api/airdrop/${airdropId}`)
            if (!res.ok) throw new Error('Failed to fetch airdrop')
            return await res.json()
        }

        async function apiGetPublicAirdrops() {
            const res = await fetch('/api/public-airdrops')
            if (!res.ok) throw new Error('Failed to fetch public airdrops')
            return await res.json()
        }

        // ==================================================================
        // HOME SCREEN
        // ==================================================================
        document.getElementById('btnCreateAirdrop').addEventListener('click', () => {
            showScreen('createScreen')
            initCreateScreen()
        })

        document.getElementById('btnJoinPublic').addEventListener('click', () => {
            showScreen('publicScreen')
            loadPublicAirdrops()
        })

        document.getElementById('btnHistory').addEventListener('click', () => {
            showScreen('historyScreen')
            loadHistory()
        })

        document.getElementById('btnLeaderboard').addEventListener('click', () => {
            showScreen('leaderboardScreen')
            loadLeaderboard()
        })

        // ==================================================================
        // CREATE AIRDROP SCREEN
        // ==================================================================
        let holdersLoaded = false

        async function initCreateScreen() {
            const type = document.getElementById('airdropTypeSelect').value
            if (type === 'space') {
                document.getElementById('holderSection').classList.remove('hidden')
                document.getElementById('perPersonSummary').classList.remove('hidden')
                document.getElementById('publicTitleGroup').classList.add('hidden')
                if (!holdersLoaded) fetchHolders()
            } else {
                document.getElementById('holderSection').classList.add('hidden')
                document.getElementById('perPersonSummary').classList.add('hidden')
                document.getElementById('publicTitleGroup').classList.remove('hidden')
                // Reset role selection when switching away from space
                document.getElementById('roleSelect').value = ''
                selectedRoleId = null
                selectedRoleName = ''
                document.getElementById('roleFilterSection').classList.add('hidden')
            }
            updatePerPerson()
            validateCreateForm()
        }

        let holdersFetching = false // guard against concurrent calls

        async function fetchHolders() {
            if (holdersFetching) return // already in progress
            holdersFetching = true

            document.getElementById('holderLoading').classList.remove('hidden')
            document.getElementById('holderLoading').innerHTML =
                '<span class="spinner-sm"></span> Fetching NFT Holders...'
            document.getElementById('holderResult').classList.add('hidden')

            const maxRetries = 3
            let lastError = null

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    if (attempt > 1) {
                        document.getElementById('holderLoading').innerHTML =
                            `<span class="spinner-sm"></span> Fetching NFT Holders... (retry ${attempt}/${maxRetries})`
                    }
                    const data = await apiFetchHolders()
                    holderCount = data.count || 0
                    taxHolderCount = data.taxHolderCount || 0
                    botTreasuryAddress = data.botAddress || ''

                    // Show space name
                    if (data.spaceName) {
                        document.getElementById('holderSpaceName').textContent = data.spaceName
                        document.getElementById('holderNameRow').classList.remove('hidden')
                    } else {
                        document.getElementById('holderNameRow').classList.add('hidden')
                    }

                    // Show the NFT contract address
                    const nftAddr = data.nftAddress || getSpaceAddress() || ''
                    if (nftAddr) {
                        document.getElementById('holderNftAddress').textContent =
                            nftAddr.slice(0, 6) + '...' + nftAddr.slice(-4)
                        document.getElementById('holderNftAddress').title = nftAddr
                        document.getElementById('holderNftRow').classList.remove('hidden')
                    } else {
                        document.getElementById('holderNftRow').classList.add('hidden')
                    }

                    document.getElementById('holderCount').textContent = holderCount

                    // Update tax member count
                    if (taxHolderCount > 0) {
                        document.getElementById('taxMemberCount').textContent = taxHolderCount
                    }

                    document.getElementById('holderLoading').classList.add('hidden')
                    document.getElementById('holderResult').classList.remove('hidden')
                    holdersLoaded = true
                    holdersFetching = false
                    updatePerPerson()
                    validateCreateForm()

                    // Fetch roles in the background (non-blocking)
                    apiFetchRoles().then(roles => {
                        spaceRoles = roles
                        populateRoleDropdown(roles)
                    })

                    return // success
                } catch (err) {
                    lastError = err
                    console.warn(`[Holders] Attempt ${attempt}/${maxRetries} failed:`, err.message)
                    if (attempt < maxRetries) {
                        // Wait 2s before retry
                        await new Promise(r => setTimeout(r, 2000))
                    }
                }
            }

            // All retries failed
            holdersFetching = false
            document.getElementById('holderLoading').innerHTML =
                '<span style="color:#fca5a5;">Failed to fetch holders after ' + maxRetries + ' attempts. <a href="#" onclick="window.retryFetchHolders();return false" style="color:#93c5fd;">Retry</a></span>'
        }

        window.retryFetchHolders = function() {
            holdersLoaded = false
            holdersFetching = false
            fetchHolders()
        }

        // Fetch bot treasury if not loaded yet (for public airdrops)
        async function ensureTreasuryAddress() {
            if (botTreasuryAddress) return
            try {
                // Use config endpoint (fast) instead of holders endpoint (slow)
                const res = await fetch('/api/config')
                if (res.ok) {
                    const data = await res.json()
                    botTreasuryAddress = data.botAddress || ''
                }
            } catch { /* ignore */ }
        }

        document.getElementById('airdropTypeSelect').addEventListener('change', () => {
            initCreateScreen()
        })

        document.getElementById('roleSelect').addEventListener('change', () => {
            const sel = document.getElementById('roleSelect')
            const val = sel.value
            if (val) {
                selectedRoleId = parseInt(val, 10)
                selectedRoleName = sel.options[sel.selectedIndex].text
            } else {
                selectedRoleId = null
                selectedRoleName = ''
            }
        })

        document.getElementById('currencySelect').addEventListener('change', () => {
            const val = document.getElementById('currencySelect').value
            const custom = document.getElementById('customCurrencyGroup')
            if (val === 'custom') {
                custom.classList.remove('hidden')
            } else {
                custom.classList.add('hidden')
                // Clear resolved token info when switching away from custom
                resolvedTokenName = ''
                resolvedTokenSymbol = ''
                resolvedTokenDecimals = 18
                tokenLookupSuccess = false
                document.getElementById('tokenInfoDisplay').classList.add('hidden')
                document.getElementById('tokenInfoError').classList.add('hidden')
                document.getElementById('customCurrencyInput').value = ''
            }
            updatePerPerson()
            validateCreateForm()
        })

        document.getElementById('amountInput').addEventListener('input', () => {
            updatePerPerson()
            validateCreateForm()
        })

        function updatePerPerson() {
            try {
                const amountStr = document.getElementById('amountInput').value.trim()
                const wei = tokensToWei(amountStr)
                const type = document.getElementById('airdropTypeSelect').value
                const label = getTokenLabel()

                // Tax summary (shown whenever a valid amount is entered)
                if (wei && BigInt(wei) > 0n && (taxPercent > 0 || adminTaxPercent > 0)) {
                    const { holderTax, adminTax, net } = computeTaxClient(wei)
                    document.getElementById('taxPercentLabel').textContent = taxPercent
                    document.getElementById('taxAmountLabel').textContent = formatTokens(holderTax.toString()) + ' ' + label

                    if (adminTaxEnabled && adminTax > 0n) {
                        document.getElementById('adminTaxPercentLabel').textContent = adminTaxPercent
                        document.getElementById('adminTaxAmountLabel').textContent = formatTokens(adminTax.toString()) + ' ' + label
                        document.getElementById('adminTaxRow').classList.remove('hidden')
                    } else {
                        document.getElementById('adminTaxRow').classList.add('hidden')
                    }

                    document.getElementById('netAmountLabel').textContent = formatTokens(net.toString()) + ' ' + label
                    document.getElementById('taxSummary').classList.remove('hidden')
                    document.getElementById('taxNote').classList.remove('hidden')

                    // Per person (space only)
                    if (type === 'space' && holderCount > 0) {
                        const perPerson = net / BigInt(holderCount)
                        document.getElementById('perPersonAmount').textContent =
                            formatTokens(perPerson.toString()) + ' ' + label
                        document.getElementById('perPersonSummary').classList.remove('hidden')
                    } else {
                        document.getElementById('perPersonSummary').classList.add('hidden')
                    }
                } else {
                    document.getElementById('taxSummary').classList.add('hidden')
                    document.getElementById('taxNote').classList.add('hidden')
                    document.getElementById('perPersonSummary').classList.add('hidden')
                }
            } catch (err) {
                console.error('[updatePerPerson] Error:', err)
            }
        }

        function validateCreateForm() {
            const type = document.getElementById('airdropTypeSelect').value
            const amount = document.getElementById('amountInput').value.trim()
            const wei = tokensToWei(amount)

            let valid = !!wei && BigInt(wei) > 0n
            if (type === 'space' && holderCount === 0) valid = false
            if (document.getElementById('currencySelect').value === 'custom') {
                const addr = document.getElementById('customCurrencyInput').value.trim()
                if (!/^0x[a-fA-F0-9]{40}$/.test(addr)) valid = false
                // Must have a successful token lookup to ensure correct decimals
                if (!tokenLookupSuccess) valid = false
            }

            document.getElementById('launchAirdropBtn').disabled = !valid
        }

        let resolvedTokenName = ''
        let resolvedTokenSymbol = ''
        let resolvedTokenDecimals = 18
        let tokenLookupSuccess = false
        let tokenLookupTimer = null

        document.getElementById('customCurrencyInput').addEventListener('input', () => {
            validateCreateForm()
            // Debounce token lookup
            clearTimeout(tokenLookupTimer)
            resolvedTokenName = ''
            resolvedTokenSymbol = ''
            resolvedTokenDecimals = 18
            tokenLookupSuccess = false
            document.getElementById('tokenInfoDisplay').classList.add('hidden')
            document.getElementById('tokenInfoError').classList.add('hidden')
            document.getElementById('tokenInfoLoading').classList.add('hidden')

            const addr = document.getElementById('customCurrencyInput').value.trim()
            if (/^0x[a-fA-F0-9]{40}$/.test(addr)) {
                tokenLookupTimer = setTimeout(() => lookupToken(addr), 400)
            }
        })

        async function lookupToken(addr) {
            tokenLookupSuccess = false
            document.getElementById('tokenInfoLoading').classList.remove('hidden')
            document.getElementById('tokenInfoError').classList.add('hidden')
            document.getElementById('tokenInfoDisplay').classList.add('hidden')
            validateCreateForm()
            try {
                const res = await fetch(`/api/token-info?address=${encodeURIComponent(addr)}`)
                const data = await res.json()
                document.getElementById('tokenInfoLoading').classList.add('hidden')
                if (!res.ok || data.error) {
                    const errMsg = data.error || 'Not a valid ERC20 token'
                    document.getElementById('tokenInfoError').innerHTML =
                        errMsg + ' <a href="#" onclick="window.retryTokenLookup();return false" style="color:#93c5fd;">Retry</a>'
                    document.getElementById('tokenInfoError').classList.remove('hidden')
                    validateCreateForm()
                    return
                }
                resolvedTokenName = data.name || ''
                resolvedTokenSymbol = data.symbol || ''
                resolvedTokenDecimals = typeof data.decimals === 'number' ? data.decimals : 18
                tokenLookupSuccess = true
                document.getElementById('tokenInfoName').textContent = resolvedTokenName
                document.getElementById('tokenInfoSymbol').textContent = resolvedTokenSymbol ? `($${resolvedTokenSymbol})` : ''
                document.getElementById('tokenInfoAddr').textContent = shortAddr(addr)
                document.getElementById('tokenInfoDisplay').classList.remove('hidden')
                // Refresh labels that use token name
                updatePerPerson()
                validateCreateForm()
            } catch {
                document.getElementById('tokenInfoLoading').classList.add('hidden')
                document.getElementById('tokenInfoError').innerHTML =
                    'Failed to look up token. <a href="#" onclick="window.retryTokenLookup();return false" style="color:#93c5fd;">Retry</a>'
                document.getElementById('tokenInfoError').classList.remove('hidden')
                validateCreateForm()
            }
        }

        window.retryTokenLookup = function() {
            const addr = document.getElementById('customCurrencyInput').value.trim()
            if (/^0x[a-fA-F0-9]{40}$/.test(addr)) {
                lookupToken(addr)
            }
        }

        document.getElementById('createBackBtn').addEventListener('click', () => {
            goBack()
        })

        document.getElementById('depositBackBtn').addEventListener('click', () => {
            stopDepositPolling()
            goBack()
        })

        // Launch Airdrop  Create + go to deposit
        document.getElementById('launchAirdropBtn').addEventListener('click', async () => {
            hideError('createError')
            const type = document.getElementById('airdropTypeSelect').value
            const amount = document.getElementById('amountInput').value.trim()
            const wei = tokensToWei(amount)
            const currency = getTokenAddress()

            if (!wei) {
                showError('createError', 'Enter a valid amount')
                return
            }

            const btn = document.getElementById('launchAirdropBtn')
            btn.disabled = true
            btn.textContent = 'Creating...'

            try {
                await ensureTreasuryAddress()
                const title = document.getElementById('airdropTitleInput').value.trim()
                const desc = document.getElementById('airdropDescInput').value.trim()
                const maxPInput = document.getElementById('maxParticipantsInput').value.trim()
                const maxP = (type === 'public' && maxPInput) ? parseInt(maxPInput, 10) : 0
                const airdrop = await apiCreateAirdrop(
                    type,
                    wei,
                    context.towns.user.userId,
                    currency,
                    getActiveDecimals(),
                    context?.user?.displayName || '',
                    getTokenSymbol(),
                    type === 'public' ? title : '',
                    type === 'public' ? desc : '',
                    maxP > 0 ? maxP : 0
                )
                currentAirdrop = airdrop
                await openDepositScreen(airdrop, amount)
            } catch (err) {
                showError('createError', err.message)
            } finally {
                btn.disabled = false
                btn.textContent = 'Launch Airdrop'
            }
        })

        // ==================================================================
        // DEPOSIT SCREEN
        // ==================================================================
        let depositPollTimer = null

        async function openDepositScreen(airdrop, humanAmount) {
            showScreen('depositScreen')
            hideError('depositError')
            document.getElementById('depositSuccess').classList.add('hidden')
            document.getElementById('depositProcessing').classList.add('hidden')
            document.getElementById('depositSendSection').classList.add('hidden')
            document.getElementById('depositInteractionSection').classList.remove('hidden')
            document.getElementById('depositWaitingSection').classList.add('hidden')

            // Derive label from airdrop data (works even when called from status screen)
            const label = airdrop.currencySymbol ? ('$' + airdrop.currencySymbol) : getTokenLabel()
            document.getElementById('depositTotal').textContent = humanAmount + ' ' + label
            document.getElementById('depositToken').textContent = label

            // Full treasury address (for manual fallback)
            document.getElementById('depositTreasuryFull').textContent =
                botTreasuryAddress || '...'
            document.getElementById('depositAmountInstructions').textContent =
                humanAmount + ' ' + label

            // Tax breakdown
            const dec = airdrop.currencyDecimals ?? getActiveDecimals()
            if (airdrop.taxPercent > 0 && airdrop.taxAmount !== '0') {
                document.getElementById('depositTaxPercent').textContent = airdrop.taxPercent
                document.getElementById('depositTaxAmount').textContent =
                    formatTokens(airdrop.taxAmount, dec) + ' ' + label
                document.getElementById('depositTaxRow').classList.remove('hidden')
            } else {
                document.getElementById('depositTaxRow').classList.add('hidden')
            }
            if (airdrop.adminTaxPercent > 0 && airdrop.adminTaxAmount && airdrop.adminTaxAmount !== '0') {
                document.getElementById('depositAdminTaxPercent').textContent = airdrop.adminTaxPercent
                document.getElementById('depositAdminTaxAmount').textContent =
                    formatTokens(airdrop.adminTaxAmount, dec) + ' ' + label
                document.getElementById('depositAdminTaxRow').classList.remove('hidden')
            } else {
                document.getElementById('depositAdminTaxRow').classList.add('hidden')
            }
            if ((airdrop.taxPercent > 0 && airdrop.taxAmount !== '0') || (airdrop.adminTaxPercent > 0 && airdrop.adminTaxAmount !== '0')) {
                document.getElementById('depositNetAmount').textContent =
                    formatTokens(airdrop.netAmount, dec) + ' ' + label
                document.getElementById('depositNetRow').classList.remove('hidden')
            } else {
                document.getElementById('depositNetRow').classList.add('hidden')
            }

            // Clear previous tx hash input
            document.getElementById('manualTxHashInput').value = ''

            // Try sending interaction request via Towns bot SDK
            try {
                const userId = context?.towns?.user?.userId
                const channelId = context?.towns?.channelId

                if (!userId || !channelId) {
                    throw new Error('Missing userId or channelId from context')
                }

                document.getElementById('depositInteractionMsg').textContent =
                    'Sending transaction request to your Towns chat...'

                const resp = await fetch(`/api/airdrop/${airdrop.id}/request-deposit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, channelId }),
                })
                const data = await resp.json()

                if (!resp.ok) {
                    throw new Error(data.error || 'Failed to send transaction request')
                }

                // Show waiting state
                document.getElementById('depositInteractionSpinner').classList.add('hidden')
                document.getElementById('depositInteractionMsg').classList.add('hidden')
                document.getElementById('depositWaitingSection').classList.remove('hidden')

                // Start polling for confirmation
                startDepositPolling(airdrop.id)

            } catch (err) {
                console.warn('[Deposit] Interaction request failed, showing manual fallback:', err.message)
                // Fall back to manual deposit
                switchToManualDeposit(err.message)
            }
        }

        function switchToManualDeposit(reason) {
            document.getElementById('depositInteractionSection').classList.add('hidden')
            document.getElementById('depositSendSection').classList.remove('hidden')
            if (reason) {
                console.log('[Deposit] Manual fallback reason:', reason)
            }
            stopDepositPolling()
        }

        function startDepositPolling(airdropId) {
            stopDepositPolling()
            let attempts = 0
            depositPollTimer = setInterval(async () => {
                attempts++
                try {
                    const resp = await fetch(`/api/airdrop/${airdropId}`)
                    if (!resp.ok) return
                    const data = await resp.json()

                    const statusEl = document.getElementById('depositPollStatus')
                    statusEl.textContent = `Waiting for confirmation... (${attempts * 3}s)`

                    if (data.status === 'funded' || data.status === 'distributing' || data.status === 'completed') {
                        stopDepositPolling()
                        currentAirdrop = data
                        document.getElementById('depositInteractionSection').classList.add('hidden')
                        document.getElementById('depositProcessing').classList.add('hidden')

                        if (data.airdropType === 'space') {
                            document.getElementById('depositSuccess').textContent =
                                'Deposit confirmed! Distribution in progress...'
                        } else {
                            document.getElementById('depositSuccess').textContent =
                                'Deposit confirmed! Your public airdrop is now live.'
                        }
                        document.getElementById('depositSuccess').classList.remove('hidden')
                        setTimeout(() => openStatusScreen(data), 2000)
                    }
                } catch (e) {
                    // ignore poll errors
                }
            }, 3000) // Poll every 3 seconds
        }

        function stopDepositPolling() {
            if (depositPollTimer) {
                clearInterval(depositPollTimer)
                depositPollTimer = null
            }
        }

        // Show manual deposit fallback
        document.getElementById('showManualDepositBtn').addEventListener('click', () => {
            switchToManualDeposit('User chose manual deposit')
        })

        // Copy treasury address to clipboard
        document.getElementById('copyAddressBtn').addEventListener('click', () => {
            const addr = botTreasuryAddress
            if (!addr) return
            navigator.clipboard.writeText(addr).then(() => {
                const msg = document.getElementById('copiedMsg')
                msg.style.opacity = '1'
                setTimeout(() => { msg.style.opacity = '0' }, 2000)
            }).catch(() => {
                // Fallback: select the text
                const el = document.getElementById('depositTreasuryFull')
                const range = document.createRange()
                range.selectNodeContents(el)
                const sel = window.getSelection()
                sel.removeAllRanges()
                sel.addRange(range)
            })
        })

        // Confirm deposit with tx hash (manual fallback)
        document.getElementById('confirmManualDepositBtn').addEventListener('click', async () => {
            hideError('depositError')
            const txHash = document.getElementById('manualTxHashInput').value.trim()
            if (!txHash || !txHash.startsWith('0x')) {
                showError('depositError', 'Enter a valid transaction hash (0x...)')
                return
            }

            const btn = document.getElementById('confirmManualDepositBtn')
            btn.disabled = true
            btn.textContent = 'Verifying...'
            document.getElementById('depositProcessing').classList.remove('hidden')
            document.getElementById('depositSendSection').classList.add('hidden')

            try {
                const updated = await apiConfirmDeposit(currentAirdrop.id, txHash)
                currentAirdrop = updated
                document.getElementById('depositProcessing').classList.add('hidden')

                if (updated.airdropType === 'space') {
                    document.getElementById('depositSuccess').textContent =
                        'Deposit confirmed! Distribution in progress...'
                } else {
                    document.getElementById('depositSuccess').textContent =
                        'Deposit confirmed! Your public airdrop is now live.'
                }
                document.getElementById('depositSuccess').classList.remove('hidden')
                setTimeout(() => openStatusScreen(updated), 2000)
            } catch (err) {
                document.getElementById('depositProcessing').classList.add('hidden')
                document.getElementById('depositSendSection').classList.remove('hidden')
                showError('depositError', err.message)
            } finally {
                btn.disabled = false
                btn.textContent = 'Confirm Deposit'
            }
        })

        // ==================================================================
        // PUBLIC AIRDROPS SCREEN
        // ==================================================================
        async function loadPublicAirdrops() {
            const listEl = document.getElementById('publicList')
            const emptyEl = document.getElementById('publicEmpty')
            const loadingEl = document.getElementById('publicLoading')
            hideError('publicError')
            listEl.innerHTML = ''
            emptyEl.classList.add('hidden')
            loadingEl.classList.remove('hidden')

            try {
                const drops = await apiGetPublicAirdrops()
                loadingEl.classList.add('hidden')

                if (drops.length === 0) {
                    emptyEl.classList.remove('hidden')
                    return
                }

                const userId = context?.towns?.user?.userId?.toLowerCase() || ''

                drops.forEach(drop => {
                    const isCreator = drop.creatorAddress?.toLowerCase() === userId
                    const canJoin = drop.status === 'funded' && drop.airdropType === 'public'
                    const alreadyJoined = isUserInParticipants(drop.participants)

                    const titleHtml = drop.title
                        ? `<div style="font-weight:700; font-size:15px; color:#e0d4f5; margin-bottom:4px;">${escapeHtml(drop.title)}</div>`
                        : ''
                    const descHtml = drop.description
                        ? `<div style="font-size:12px; opacity:0.7; margin-bottom:6px;">${renderDescription(drop.description)}</div>`
                        : ''

                    const card = document.createElement('div')
                    card.className = 'airdrop-card'
                    card.innerHTML = `
                        ${titleHtml}
                        ${descHtml}
                        <div class="airdrop-card-header">
                            <span class="airdrop-card-title">${formatTokens(drop.totalAmount, drop.currencyDecimals ?? 18)} ${drop.currencySymbol ? '$' + drop.currencySymbol : 'tokens'}</span>
                            <span class="status-badge status-${drop.status}">${drop.status.toUpperCase()}</span>
                        </div>
                        <div class="airdrop-card-detail">${drop.recipientCount} participant${drop.recipientCount !== 1 ? 's' : ''}${drop.maxParticipants > 0 ? ' / ' + drop.maxParticipants + ' max' : ''}</div>
                        <div class="airdrop-card-detail">Per person: ${drop.recipientCount > 0 ? formatTokens(drop.amountPerRecipient, drop.currencyDecimals ?? 18) : ''} ${drop.currencySymbol ? '$' + drop.currencySymbol : 'tokens'}</div>
                        <div class="airdrop-card-detail" style="opacity:0.4;">Created by ${drop.creatorName || shortAddr(drop.creatorAddress)}</div>
                        <div class="airdrop-card-actions">
                            ${canJoin && !alreadyJoined && !(drop.maxParticipants > 0 && drop.recipientCount >= drop.maxParticipants) ? `<button class="sm" onclick="joinPublicDrop('${drop.id}')">Join</button>` : ''}
                            ${canJoin && !alreadyJoined && drop.maxParticipants > 0 && drop.recipientCount >= drop.maxParticipants ? `<button class="sm secondary" disabled>Full</button>` : ''}
                            ${alreadyJoined ? `<button class="sm joined" disabled>&#10003; Joined</button>` : ''}
                            <button class="sm secondary" onclick="viewDrop('${drop.id}')">View Details</button>
                            ${isAdmin ? `<button class="sm danger" onclick="adminCancelDrop('${drop.id}', this)">Cancel</button>` : ''}
                        </div>
                    `
                    listEl.appendChild(card)
                })
            } catch (err) {
                loadingEl.classList.add('hidden')
                showError('publicError', err.message)
            }
        }

        document.getElementById('publicBackBtn').addEventListener('click', () => {
            goBack()
        })

        // Global handlers for inline onclick
        window.joinPublicDrop = async function(id) {
            try {
                const updated = await apiJoinAirdrop(id)
                currentAirdrop = updated
                openStatusScreen(updated)
            } catch (err) {
                alert(err.message)
            }
        }

        window.managePublicDrop = async function(id) {
            try {
                const drop = await apiGetAirdrop(id)
                currentAirdrop = drop
                openStatusScreen(drop)
            } catch (err) {
                alert(err.message)
            }
        }

        window.viewDrop = async function(id) {
            try {
                const drop = await apiGetAirdrop(id)
                currentAirdrop = drop
                openStatusScreen(drop)
            } catch (err) {
                alert(err.message)
            }
        }

        window.adminCancelDrop = async function(id, btnEl) {
            // Two-click confirmation: first click shows confirm text, second click executes
            if (!btnEl.dataset.confirmed) {
                btnEl.dataset.confirmed = 'true'
                btnEl.textContent = 'Confirm Cancel?'
                btnEl.style.opacity = '1'
                setTimeout(() => {
                    if (btnEl) { delete btnEl.dataset.confirmed; btnEl.textContent = 'Cancel' }
                }, 4000)
                return
            }
            btnEl.disabled = true
            btnEl.textContent = 'Cancelling...'
            try {
                const userId = context?.towns?.user?.userId || ''
                const res = await fetch(`/api/airdrop/${id}/admin-cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                })
                const data = await res.json()
                if (!res.ok) throw new Error(data.error || 'Failed to cancel')
                loadPublicAirdrops()
            } catch (err) {
                btnEl.disabled = false
                btnEl.textContent = 'Cancel'
                delete btnEl.dataset.confirmed
                showError('publicError', err.message)
            }
        }

        // ==================================================================
        // STATUS / MANAGE SCREEN
        // ==================================================================
        function openStatusScreen(airdrop) {
            currentAirdrop = airdrop
            showScreen('statusScreen')
            updateStatusUI(airdrop)
            startPolling(airdrop.id)
        }

        // Auto-distribution countdown
        let autoDistTimer = null
        let autoDistSeconds = 10

        function startAutoDistCountdown(msgEl) {
            if (autoDistTimer) return // already running
            autoDistSeconds = 10
            renderCountdown(msgEl)
            autoDistTimer = setInterval(() => {
                autoDistSeconds--
                if (autoDistSeconds <= 0) {
                    stopAutoDistCountdown()
                    msgEl.innerHTML = '<div class="info-box"><span class="spinner-sm"></span> Distributing tokens... please wait.</div>'
                } else {
                    renderCountdown(msgEl)
                }
            }, 1000)
        }

        function renderCountdown(msgEl) {
            msgEl.innerHTML = `<div class="info-box" style="text-align:center;">
                <div style="font-size:18px; font-weight:700; color:#22c55e; margin-bottom:6px;"> Airdrop is full!</div>
                <div>Distribution will start in <strong>${autoDistSeconds}s</strong></div>
            </div>`
        }

        function stopAutoDistCountdown() {
            if (autoDistTimer) {
                clearInterval(autoDistTimer)
                autoDistTimer = null
            }
        }

        function updateStatusUI(airdrop) {
            const badge = document.getElementById('statusBadge')
            badge.textContent = airdrop.status.toUpperCase()
            badge.className = 'status-badge status-' + airdrop.status

            // Title/description
            const titleEl = document.getElementById('statusTitle')
            const descEl = document.getElementById('statusDesc')
            if (airdrop.title) {
                titleEl.textContent = airdrop.title
                titleEl.classList.remove('hidden')
            } else {
                titleEl.classList.add('hidden')
            }
            if (airdrop.description) {
                descEl.innerHTML = renderDescription(airdrop.description)
                descEl.classList.remove('hidden')
            } else {
                descEl.classList.add('hidden')
            }

            const typeLabel = airdrop.airdropType === 'space'
                ? (airdrop.spaceName ? airdrop.spaceName + ' Members' : 'Space Members')
                : 'Public'
            document.getElementById('statusType').textContent = typeLabel
            // Show role filter if set
            if (airdrop.roleName) {
                document.getElementById('statusRoleName').textContent = airdrop.roleName
                document.getElementById('statusRoleRow').classList.remove('hidden')
            } else {
                document.getElementById('statusRoleRow').classList.add('hidden')
            }
            const dec = airdrop.currencyDecimals ?? 18
            const sym = airdrop.currencySymbol ? '$' + airdrop.currencySymbol : 'tokens'
            document.getElementById('statusTotal').textContent = formatTokens(airdrop.totalAmount, dec) + ' ' + sym

            // Tax info
            if (airdrop.taxPercent > 0 && airdrop.taxAmount && airdrop.taxAmount !== '0') {
                document.getElementById('statusTaxPercent').textContent = airdrop.taxPercent
                document.getElementById('statusTaxAmount').textContent = formatTokens(airdrop.taxAmount, dec) + ' ' + sym
                document.getElementById('statusTaxRow').classList.remove('hidden')
            } else {
                document.getElementById('statusTaxRow').classList.add('hidden')
            }
            if (airdrop.adminTaxPercent > 0 && airdrop.adminTaxAmount && airdrop.adminTaxAmount !== '0') {
                document.getElementById('statusAdminTaxPercent').textContent = airdrop.adminTaxPercent
                document.getElementById('statusAdminTaxAmount').textContent = formatTokens(airdrop.adminTaxAmount, dec) + ' ' + sym
                document.getElementById('statusAdminTaxRow').classList.remove('hidden')
            } else {
                document.getElementById('statusAdminTaxRow').classList.add('hidden')
            }
            if ((airdrop.taxPercent > 0 && airdrop.taxAmount !== '0') || (airdrop.adminTaxPercent > 0 && airdrop.adminTaxAmount !== '0')) {
                document.getElementById('statusNetAmount').textContent = formatTokens(airdrop.netAmount, dec) + ' ' + sym
                document.getElementById('statusNetRow').classList.remove('hidden')
            } else {
                document.getElementById('statusNetRow').classList.add('hidden')
            }
            // Show holder tax note on status screen
            if (airdrop.taxPercent > 0 && airdrop.taxAmount && airdrop.taxAmount !== '0') {
                document.getElementById('statusTaxMemberCount').textContent = airdrop.taxHolderCount || 0
                document.getElementById('statusTaxNote').classList.remove('hidden')
            } else {
                document.getElementById('statusTaxNote').classList.add('hidden')
            }

            document.getElementById('statusPerRecipient').textContent =
                airdrop.recipientCount > 0 ? formatTokens(airdrop.amountPerRecipient, dec) + ' ' + sym : ''
            document.getElementById('statusRecipientCount').textContent = airdrop.recipientCount

            const userId = context?.towns?.user?.userId?.toLowerCase() || ''
            const isCreator = airdrop.creatorAddress?.toLowerCase() === userId
            const isPublic = airdrop.airdropType === 'public'
            const maxP = airdrop.maxParticipants || 0

            // Join section (public, funded)
            const joinSection = document.getElementById('statusJoinSection')
            const alreadyJoined = isUserInParticipants(airdrop.participants)
            const isFull = maxP > 0 && airdrop.recipientCount >= maxP
            const joinBtn = document.getElementById('statusJoinBtn')
            if (isPublic && airdrop.status === 'funded') {
                joinSection.classList.remove('hidden')
                if (alreadyJoined) {
                    joinBtn.innerHTML = '&#10003; Joined'
                    joinBtn.className = 'joined'
                    joinBtn.disabled = true
                } else if (isFull) {
                    joinBtn.textContent = 'Full'
                    joinBtn.className = 'secondary'
                    joinBtn.disabled = true
                } else {
                    joinBtn.textContent = 'Join This Airdrop'
                    joinBtn.className = ''
                    joinBtn.disabled = false
                }
            } else {
                joinSection.classList.add('hidden')
            }

            // Participants list
            const partSection = document.getElementById('statusParticipantsSection')
            if (isPublic && airdrop.participants?.length > 0) {
                partSection.classList.remove('hidden')
                const listEl = document.getElementById('statusParticipantsList')
                const names = airdrop.participantNames || {}
                listEl.innerHTML = airdrop.participants.map(p => {
                    const name = names[p]
                    return name
                        ? `<div class="participant"><strong>${name}</strong> <span style="opacity:0.5; font-size:11px;">${shortAddr(p)}</span></div>`
                        : `<div class="participant">${shortAddr(p)}</div>`
                }).join('')
            } else {
                partSection.classList.add('hidden')
            }

            // Max participants
            if (maxP > 0) {
                document.getElementById('statusMaxParticipants').textContent = `${airdrop.recipientCount} / ${maxP}`
                document.getElementById('statusMaxParticipantsRow').classList.remove('hidden')
            } else {
                document.getElementById('statusMaxParticipantsRow').classList.add('hidden')
            }

            // Pending section (creator can fund or cancel)
            const pendingSection = document.getElementById('statusPendingSection')
            if (isCreator && airdrop.status === 'pending') {
                pendingSection.classList.remove('hidden')
            } else {
                pendingSection.classList.add('hidden')
            }

            // Manage section (creator, public, funded, has participants)
            const manageSection = document.getElementById('statusManageSection')
            if (isCreator && isPublic && airdrop.status === 'funded' && airdrop.recipientCount > 0) {
                manageSection.classList.remove('hidden')
            } else {
                manageSection.classList.add('hidden')
            }

            // Admin cancel section (admin, not completed/distributing)
            const adminSection = document.getElementById('statusAdminSection')
            if (isAdmin && airdrop.status !== 'completed' && airdrop.status !== 'distributing' && airdrop.status !== 'cancelled') {
                adminSection.classList.remove('hidden')
                const acBtn = document.getElementById('statusAdminCancelBtn')
                acBtn.textContent = airdrop.status === 'funded'
                    ? 'Admin: Cancel & Refund'
                    : 'Admin: Cancel'
            } else {
                adminSection.classList.add('hidden')
            }

            // Result section
            const resultSection = document.getElementById('statusResultSection')
            const resultMsg = document.getElementById('statusResultMessage')
            if (airdrop.status === 'completed') {
                resultSection.classList.remove('hidden')
                stopAutoDistCountdown()
                const txLink = airdrop.txHash
                    ? ` <a href="https://basescan.org/tx/${airdrop.txHash}" target="_blank">View on Basescan</a>`
                    : ''
                resultMsg.innerHTML = `<div class="success">Airdrop completed! ${airdrop.recipientCount} recipients received tokens.${txLink}</div>`
            } else if (airdrop.status === 'distributing') {
                resultSection.classList.remove('hidden')
                stopAutoDistCountdown()
                resultMsg.innerHTML = '<div class="info-box"><span class="spinner-sm"></span> Distributing tokens... please wait.</div>'
            } else if (airdrop.status === 'funded' && maxP > 0 && airdrop.recipientCount >= maxP) {
                // Max participants reached  show countdown before auto-distribution
                resultSection.classList.remove('hidden')
                startAutoDistCountdown(resultMsg)
            } else {
                resultSection.classList.add('hidden')
                stopAutoDistCountdown()
            }
        }

        // Join from status screen
        document.getElementById('statusJoinBtn').addEventListener('click', async () => {
            if (!currentAirdrop) return
            hideError('statusError')
            const btn = document.getElementById('statusJoinBtn')
            btn.disabled = true
            btn.textContent = 'Joining...'
            try {
                const updated = await apiJoinAirdrop(currentAirdrop.id)
                currentAirdrop = updated
                updateStatusUI(updated)
            } catch (err) {
                showError('statusError', err.message)
                btn.disabled = false
                btn.textContent = 'Join This Airdrop'
            }
        })

        // Distribute from status screen
        document.getElementById('statusDistributeBtn').addEventListener('click', async () => {
            if (!currentAirdrop) return
            hideError('statusError')
            const btn = document.getElementById('statusDistributeBtn')
            btn.disabled = true
            btn.textContent = 'Distributing...'
            try {
                const updated = await apiLaunchAirdrop(currentAirdrop.id)
                currentAirdrop = updated
                updateStatusUI(updated)
            } catch (err) {
                showError('statusError', err.message)
            } finally {
                btn.disabled = false
                btn.textContent = 'Distribute Now'
            }
        })

        // Fund from status screen (opens deposit screen)
        document.getElementById('statusFundBtn').addEventListener('click', async () => {
            if (!currentAirdrop) return
            hideError('statusError')
            const btn = document.getElementById('statusFundBtn')
            btn.disabled = true
            btn.textContent = 'Loading...'
            try {
                await ensureTreasuryAddress()
                // Calculate human-readable amount
                const dec = currentAirdrop.currencyDecimals ?? 18
                const humanAmount = weiToTokens(currentAirdrop.totalAmount, dec)
                await openDepositScreen(currentAirdrop, humanAmount)
            } catch (err) {
                showError('statusError', err.message)
            } finally {
                btn.disabled = false
                btn.textContent = 'Fund This Airdrop'
            }
        })

        // Cancel from status screen
        document.getElementById('statusCancelBtn').addEventListener('click', async () => {
            if (!currentAirdrop) return
            hideError('statusError')
            const btn = document.getElementById('statusCancelBtn')
            btn.disabled = true
            btn.textContent = 'Canceling...'
            try {
                const res = await fetch(`/api/airdrop/${currentAirdrop.id}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                })
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}))
                    throw new Error(err.error || 'Failed to cancel')
                }
                const updated = await res.json()
                currentAirdrop = updated
                updateStatusUI(updated)
            } catch (err) {
                showError('statusError', err.message)
            } finally {
                btn.disabled = false
                btn.textContent = 'Cancel Airdrop'
            }
        })

        // Admin cancel from status screen (two-click confirmation)
        document.getElementById('statusAdminCancelBtn').addEventListener('click', async () => {
            if (!currentAirdrop) return
            const btn = document.getElementById('statusAdminCancelBtn')

            // First click: ask confirmation
            if (!btn.dataset.confirmed) {
                btn.dataset.confirmed = 'true'
                btn.textContent = 'Confirm Cancel?'
                setTimeout(() => {
                    if (btn) { delete btn.dataset.confirmed; btn.textContent = currentAirdrop?.status === 'funded' ? 'Admin: Cancel & Refund' : 'Admin: Cancel' }
                }, 4000)
                return
            }

            hideError('statusError')
            btn.disabled = true
            btn.textContent = currentAirdrop.status === 'funded' ? 'Refunding...' : 'Canceling...'
            try {
                const userId = context?.towns?.user?.userId || ''
                const res = await fetch(`/api/airdrop/${currentAirdrop.id}/admin-cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                })
                const data = await res.json()
                if (!res.ok) throw new Error(data.error || 'Failed to cancel')
                currentAirdrop = data
                updateStatusUI(data)
                if (data.refundTxHash) {
                    document.getElementById('statusResultSection').classList.remove('hidden')
                    document.getElementById('statusResultMessage').innerHTML =
                        `<div class="success">Cancelled & refunded. <a href="https://basescan.org/tx/${data.refundTxHash}" target="_blank">View tx</a></div>`
                }
            } catch (err) {
                showError('statusError', err.message)
            } finally {
                btn.disabled = false
                delete btn.dataset.confirmed
                btn.textContent = currentAirdrop?.status === 'funded' ? 'Admin: Cancel & Refund' : 'Admin: Cancel'
            }
        })

        document.getElementById('statusBackBtn').addEventListener('click', () => {
            goBack()
        })
        document.getElementById('statusHomeBtn').addEventListener('click', () => {
            goBack()
        })

        // Polling
        function startPolling(airdropId) {
            if (pollInterval) clearInterval(pollInterval)
            pollInterval = setInterval(async () => {
                try {
                    const drop = await apiGetAirdrop(airdropId)
                    currentAirdrop = drop
                    updateStatusUI(drop)
                    document.getElementById('pollStatus').textContent =
                        'Updated ' + new Date().toLocaleTimeString()
                    if (drop.status === 'completed' || drop.status === 'cancelled') {
                        clearInterval(pollInterval)
                        pollInterval = null
                    }
                } catch (err) {
                    console.error('Poll error:', err)
                }
            }, 3000)
        }

        // ==================================================================
        // HELPER: HTML escaping & link preview
        // ==================================================================
        function escapeHtml(str) {
            const div = document.createElement('div')
            div.textContent = str
            return div.innerHTML
        }

        function renderDescription(desc) {
            const trimmed = desc.trim()

            // Check if the entire description is a single URL  show a link preview card
            const singleUrlMatch = trimmed.match(/^(https?:\/\/[^\s<]+)$/)
            if (singleUrlMatch) {
                const url = singleUrlMatch[1]
                let domain = ''
                try { domain = new URL(url).hostname } catch { domain = url }
                return `<div class="link-preview"><a href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(domain)}</a><br/><span style="opacity:0.5; font-size:11px;">${escapeHtml(url)}</span></div>`
            }

            // Otherwise, escape HTML and turn URLs into clickable links
            const escaped = escapeHtml(desc)
            return escaped.replace(/(https?:\/\/[^\s<]+)/g, (url) => {
                return `<a href="${url}" target="_blank" rel="noopener">${url}</a>`
            })
        }

        // ==================================================================
        // LEADERBOARD SCREEN
        // ==================================================================
        document.getElementById('leaderboardBackBtn').addEventListener('click', () => {
            goBack()
        })

        async function loadLeaderboard() {
            const loadingEl = document.getElementById('leaderboardLoading')
            const contentEl = document.getElementById('leaderboardContent')
            hideError('leaderboardError')
            loadingEl.classList.remove('hidden')
            contentEl.classList.add('hidden')

            try {
                const res = await fetch('/api/leaderboard')
                if (!res.ok) throw new Error('Failed to load leaderboard')
                const data = await res.json()
                loadingEl.classList.add('hidden')
                contentEl.classList.remove('hidden')

                // Render recipients
                renderLeaderboardList('lbRecipients', 'lbRecipientsEmpty', data.topRecipients, (item) => {
                    return `${item.displayName || shortAddr(item.address)} <span class="leaderboard-stat">${item.count} airdrop${item.count !== 1 ? 's' : ''}</span>`
                })

                // Render creators
                renderLeaderboardList('lbCreators', 'lbCreatorsEmpty', data.topCreators, (item) => {
                    return `${item.displayName || shortAddr(item.address)} <span class="leaderboard-stat">${item.count} created</span>`
                })

                // Render spaces
                renderLeaderboardList('lbSpaces', 'lbSpacesEmpty', data.topSpaces, (item) => {
                    const name = item.spaceName || shortAddr(item.spaceNftAddress)
                    return `${name} <span class="leaderboard-stat">${item.count} airdrop${item.count !== 1 ? 's' : ''}</span>`
                })

                // Show admin reset button
                if (isAdmin) {
                    document.getElementById('leaderboardAdminSection').classList.remove('hidden')
                }
            } catch (err) {
                loadingEl.classList.add('hidden')
                showError('leaderboardError', err.message)
            }
        }

        function renderLeaderboardList(listId, emptyId, items, renderItem) {
            const listEl = document.getElementById(listId)
            const emptyEl = document.getElementById(emptyId)
            listEl.innerHTML = ''

            if (!items || items.length === 0) {
                emptyEl.classList.remove('hidden')
                return
            }
            emptyEl.classList.add('hidden')

            items.forEach((item, idx) => {
                const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : ''
                const el = document.createElement('div')
                el.className = 'leaderboard-item'
                el.innerHTML = `
                    <span class="leaderboard-rank ${rankClass}">${idx + 1}</span>
                    <span class="leaderboard-name">${renderItem(item)}</span>
                `
                listEl.appendChild(el)
            })
        }

        // ==================================================================
        // HISTORY SCREEN
        // ==================================================================
        document.getElementById('historyBackBtn').addEventListener('click', () => {
            goBack()
        })

        async function loadHistory() {
            const listEl = document.getElementById('historyList')
            const emptyEl = document.getElementById('historyEmpty')
            const loadingEl = document.getElementById('historyLoading')
            hideError('historyError')
            listEl.innerHTML = ''
            emptyEl.classList.add('hidden')
            loadingEl.classList.remove('hidden')

            try {
                const res = await fetch('/api/airdrop-history')
                if (!res.ok) throw new Error('Failed to load history')
                const drops = await res.json()
                loadingEl.classList.add('hidden')

                if (drops.length === 0) {
                    emptyEl.classList.remove('hidden')
                    return
                }

                drops.forEach(drop => {
                    const sym = drop.currencySymbol ? '$' + drop.currencySymbol : 'tokens'
                    const dec = drop.currencyDecimals ?? 18
                    const date = new Date(drop.createdAt).toLocaleDateString()

                    const titleHtml = drop.title
                        ? `<div style="font-weight:700; font-size:14px; color:#e0d4f5; margin-bottom:2px;">${escapeHtml(drop.title)}</div>`
                        : ''
                    const descHtml = drop.description
                        ? `<div style="font-size:11px; opacity:0.6; margin-bottom:4px;">${renderDescription(drop.description)}</div>`
                        : ''

                    const card = document.createElement('div')
                    card.className = 'airdrop-card'
                    card.innerHTML = `
                        ${titleHtml}
                        ${descHtml}
                        <div class="airdrop-card-header">
                            <span class="airdrop-card-title">${formatTokens(drop.totalAmount, dec)} ${sym}</span>
                            <span class="status-badge status-${drop.status}">${drop.status.toUpperCase()}</span>
                        </div>
                        <div class="airdrop-card-detail">${drop.airdropType === 'space' ? (drop.spaceName ? drop.spaceName + ' Members' : 'Space Members') : 'Public'}${drop.roleName ? ' &middot; ' + drop.roleName : ''} &middot; ${drop.recipientCount} recipient${drop.recipientCount !== 1 ? 's' : ''}</div>
                        <div class="airdrop-card-detail" style="opacity:0.4;">By ${drop.creatorName || shortAddr(drop.creatorAddress)} &middot; ${date}</div>
                        <div class="airdrop-card-actions">
                            <button class="sm secondary" onclick="viewDrop('${drop.id}')">View Details</button>
                        </div>
                    `
                    listEl.appendChild(card)
                })

                // Show admin reset button
                if (isAdmin) {
                    document.getElementById('historyAdminSection').classList.remove('hidden')
                }
            } catch (err) {
                loadingEl.classList.add('hidden')
                showError('historyError', err.message)
            }
        }

        // ==================================================================
        // ADMIN RESET HANDLERS
        // ==================================================================
        document.getElementById('resetLeaderboardBtn').addEventListener('click', async () => {
            const btn = document.getElementById('resetLeaderboardBtn')
            // Two-click confirmation
            if (!btn.dataset.confirmed) {
                btn.dataset.confirmed = 'true'
                btn.textContent = 'Confirm Reset?'
                setTimeout(() => { if (btn) { delete btn.dataset.confirmed; btn.textContent = 'Reset Leaderboard' } }, 4000)
                return
            }
            btn.disabled = true
            btn.textContent = 'Resetting...'
            try {
                const userId = context?.towns?.user?.userId || ''
                const res = await fetch('/api/admin/reset-leaderboard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                })
                const data = await res.json()
                if (!res.ok) throw new Error(data.error || 'Failed to reset')
                loadLeaderboard()
            } catch (err) {
                showError('leaderboardError', err.message)
            } finally {
                btn.disabled = false
                delete btn.dataset.confirmed
                btn.textContent = 'Reset Leaderboard'
            }
        })

        document.getElementById('resetHistoryBtn').addEventListener('click', async () => {
            const btn = document.getElementById('resetHistoryBtn')
            // Two-click confirmation
            if (!btn.dataset.confirmed) {
                btn.dataset.confirmed = 'true'
                btn.textContent = 'Confirm Reset?'
                setTimeout(() => { if (btn) { delete btn.dataset.confirmed; btn.textContent = 'Reset History' } }, 4000)
                return
            }
            btn.disabled = true
            btn.textContent = 'Resetting...'
            try {
                const userId = context?.towns?.user?.userId || ''
                const res = await fetch('/api/admin/reset-history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                })
                const data = await res.json()
                if (!res.ok) throw new Error(data.error || 'Failed to reset')
                loadHistory()
            } catch (err) {
                showError('historyError', err.message)
            } finally {
                btn.disabled = false
                delete btn.dataset.confirmed
                btn.textContent = 'Reset History'
            }
        })

        // ==================================================================
        // RECOVER FUNDS SCREEN
        // ==================================================================
        let recoverTokenDecimals = 18
        let recoverTokenSymbol = ''
        let recoverBalanceWei = '0'

        document.getElementById('btnRecoverFunds').addEventListener('click', () => {
            showScreen('recoverScreen')
            initRecoverScreen()
        })

        document.getElementById('recoverBackBtn').addEventListener('click', () => {
            goBack()
        })

        document.getElementById('recoverTokenSelect').addEventListener('change', () => {
            const val = document.getElementById('recoverTokenSelect').value
            if (val === 'custom') {
                document.getElementById('recoverCustomGroup').classList.remove('hidden')
            } else {
                document.getElementById('recoverCustomGroup').classList.add('hidden')
            }
            resetRecoverState()
            if (val !== 'custom') fetchRecoverBalance()
        })

        document.getElementById('recoverCustomInput').addEventListener('input', () => {
            resetRecoverState()
            const addr = document.getElementById('recoverCustomInput').value.trim()
            if (/^0x[a-fA-F0-9]{40}$/.test(addr)) {
                fetchRecoverBalance()
            }
        })

        document.getElementById('recoverAmountInput').addEventListener('input', () => {
            validateRecoverForm()
        })

        function initRecoverScreen() {
            document.getElementById('recoverTokenSelect').value = 'towns'
            document.getElementById('recoverCustomGroup').classList.add('hidden')
            document.getElementById('recoverCustomInput').value = ''
            document.getElementById('recoverAmountInput').value = ''
            resetRecoverState()
            fetchRecoverBalance()
        }

        function resetRecoverState() {
            recoverBalanceWei = '0'
            recoverTokenDecimals = 18
            recoverTokenSymbol = ''
            document.getElementById('recoverBalanceSection').classList.add('hidden')
            document.getElementById('recoverBalanceLoading').classList.add('hidden')
            document.getElementById('recoverSuccess').classList.add('hidden')
            hideError('recoverError')
            document.getElementById('recoverBtn').disabled = true
        }

        function getRecoverTokenAddress() {
            const sel = document.getElementById('recoverTokenSelect').value
            if (KNOWN_TOKENS[sel]) return KNOWN_TOKENS[sel].address
            return document.getElementById('recoverCustomInput').value.trim()
        }

        function getRecoverDecimals() {
            const sel = document.getElementById('recoverTokenSelect').value
            if (KNOWN_TOKENS[sel]) return KNOWN_TOKENS[sel].decimals
            return recoverTokenDecimals
        }

        function getRecoverSymbol() {
            const sel = document.getElementById('recoverTokenSelect').value
            if (KNOWN_TOKENS[sel]) return '$' + KNOWN_TOKENS[sel].symbol
            return recoverTokenSymbol ? '$' + recoverTokenSymbol : 'tokens'
        }

        async function fetchRecoverBalance() {
            const addr = getRecoverTokenAddress()
            if (!addr || !/^0x[a-fA-F0-9]{40}$/.test(addr)) return

            document.getElementById('recoverBalanceLoading').classList.remove('hidden')
            document.getElementById('recoverBalanceSection').classList.add('hidden')

            try {
                // For custom tokens, also fetch decimals/symbol
                const sel = document.getElementById('recoverTokenSelect').value
                if (sel === 'custom') {
                    const infoRes = await fetch(`/api/token-info?address=${encodeURIComponent(addr)}`)
                    if (infoRes.ok) {
                        const info = await infoRes.json()
                        recoverTokenDecimals = info.decimals ?? 18
                        recoverTokenSymbol = info.symbol || ''
                    }
                }

                const res = await fetch(`/api/admin/treasury-balance?token=${encodeURIComponent(addr)}`)
                if (!res.ok) throw new Error('Failed to fetch balance')
                const data = await res.json()

                recoverBalanceWei = data.balance || '0'
                const dec = getRecoverDecimals()
                const sym = getRecoverSymbol()

                document.getElementById('recoverBalance').textContent =
                    formatTokens(recoverBalanceWei, dec) + ' ' + sym
                document.getElementById('recoverTreasury').textContent = shortAddr(data.treasury || '')
                document.getElementById('recoverTreasury').title = data.treasury || ''

                document.getElementById('recoverBalanceLoading').classList.add('hidden')
                document.getElementById('recoverBalanceSection').classList.remove('hidden')
                validateRecoverForm()
            } catch (err) {
                document.getElementById('recoverBalanceLoading').classList.add('hidden')
                showError('recoverError', 'Failed to fetch balance: ' + err.message)
            }
        }

        function validateRecoverForm() {
            const input = document.getElementById('recoverAmountInput').value.trim().toLowerCase()
            const bal = BigInt(recoverBalanceWei)
            if (bal <= 0n) {
                document.getElementById('recoverBtn').disabled = true
                return
            }
            if (input === 'max') {
                document.getElementById('recoverBtn').disabled = false
                return
            }
            const wei = tokensToWei(input, getRecoverDecimals())
            document.getElementById('recoverBtn').disabled = !wei || BigInt(wei) <= 0n || BigInt(wei) > bal
        }

        // Two-click confirmation for recover
        document.getElementById('recoverBtn').addEventListener('click', async () => {
            const btn = document.getElementById('recoverBtn')
            if (!btn.dataset.confirmed) {
                btn.dataset.confirmed = 'true'
                btn.textContent = 'Confirm Recovery?'
                setTimeout(() => { if (btn) { delete btn.dataset.confirmed; btn.textContent = 'Recover Funds' } }, 4000)
                return
            }

            hideError('recoverError')
            document.getElementById('recoverSuccess').classList.add('hidden')
            btn.disabled = true
            btn.textContent = 'Recovering...'
            delete btn.dataset.confirmed

            try {
                const input = document.getElementById('recoverAmountInput').value.trim().toLowerCase()
                let amountWei
                if (input === 'max') {
                    amountWei = recoverBalanceWei
                } else {
                    amountWei = tokensToWei(input, getRecoverDecimals())
                }

                if (!amountWei || BigInt(amountWei) <= 0n) {
                    throw new Error('Invalid amount')
                }

                const userId = context?.towns?.user?.userId || ''
                const res = await fetch('/api/admin/recover-funds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        tokenAddress: getRecoverTokenAddress(),
                        amount: amountWei,
                    })
                })
                const data = await res.json()
                if (!res.ok) throw new Error(data.error || 'Failed to recover')

                const dec = getRecoverDecimals()
                const sym = getRecoverSymbol()
                const txLink = data.txHash
                    ? ` <a href="https://basescan.org/tx/${data.txHash}" target="_blank" style="color:#93c5fd;">View tx</a>`
                    : ''
                document.getElementById('recoverSuccess').innerHTML =
                    `Recovered ${formatTokens(amountWei, dec)} ${sym} to ${shortAddr(data.recipient)}${txLink}`
                document.getElementById('recoverSuccess').classList.remove('hidden')

                // Refresh balance
                fetchRecoverBalance()
            } catch (err) {
                showError('recoverError', err.message)
            } finally {
                btn.disabled = false
                btn.textContent = 'Recover Funds'
            }
        })

        // ==================================================================
        // INIT
        // ==================================================================
        async function init() {
            try {
                // Fetch config (tax rate, bot address) in parallel with SDK init
                const [, ] = await Promise.all([
                    initSDK(),
                    apiFetchConfig(),
                ])

                // Check if user is admin
                const userId = context?.towns?.user?.userId || ''
                if (adminAddress && userId && userId.toLowerCase() === adminAddress) {
                    isAdmin = true
                    document.getElementById('adminHomeSection').classList.remove('hidden')
                }

                // Resolve user's smart wallet for alreadyJoined checks
                const userAddr = context?.towns?.user?.address || ''
                if (userId) {
                    try {
                        const wRes = await fetch(`/api/user-wallet?userId=${encodeURIComponent(userId)}`)
                        if (wRes.ok) {
                            const wData = await wRes.json()
                            if (wData.wallet) resolvedUserWallet = wData.wallet.toLowerCase()
                        }
                    } catch { /* ignore */ }
                }
                // Also use context address if available
                if (!resolvedUserWallet && userAddr) {
                    resolvedUserWallet = userAddr.toLowerCase()
                }

                document.getElementById('loading').style.display = 'none'
                document.getElementById('app').style.display = 'block'

                // Username
                const displayName = context.user?.displayName || 'User'
                document.getElementById('homeUsername').textContent = displayName

                showScreen('homeScreen')

            } catch (err) {
                console.error('Init failed:', err)
                document.getElementById('loading').innerHTML =
                    '<div class="error">Failed to initialize. Make sure you are in a Towns channel.</div>'
            }
        }

        init()
    </script>
</body>
</html>
